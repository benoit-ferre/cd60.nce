
# cd60.nce ‚Äì Huawei iMaster NCE‚ÄëCampus (Tenant view)

**Language:** English  
**Auth:** token‚Äëonly (generated by `nce_auth`)  
**TLS:** self‚Äësigned allowed (`validate_certs: false`)  
**Default Base URI:** `https://weu.naas.huawei.com:18002`

---

## ‚ú® What‚Äôs inside

- **Modules**
  - `nce_auth` ‚Äî obtain / revoke token (`POST`/`DELETE` `/controller/v2/tokens`)
  - `nce_site` ‚Äî CRUD for *Sites* (single object, idempotent)
  - `nce_device` ‚Äî CRUD for *Devices* (single object, idempotent)
- **Plugins**
  - Lookup: `nce_lookup` ‚Äî `lookup('sites'|'devices', '<identifier|name>')`
  - Inventory: `nce_inventory` ‚Äî builds inventory from **devices**; strict filename: `nce.yml|nce.yaml`
- **Conventions enforced**
  - Inputs under `object` (MUST include `name`)
  - Uniqueness under `selector` (key‚Üívalue **without `name`**)
  - Idempotent modules (detect create vs update automatically)

---

## ‚öôÔ∏è Requirements

- Ansible 2.14+ (recommended 2.15+)
- Python 3.9+
- Access to Huawei iMaster NCE‚ÄëCampus **tenant view**

---

## üì¶ Installation

### Option A ‚Äî Use this ZIP as a *source* collection (no build)

1. Unzip in your project so the path looks like:
   ```
   <project>/collections/ansible_collections/cd60/nce/
   ```
2. Export the collections path when running Ansible:
   ```bash
   export ANSIBLE_COLLECTIONS_PATHS="$(pwd)"
   ```

### Option B ‚Äî Build a Galaxy artifact and install

> Requires `ansible-galaxy` locally.

```bash
# From your project root that contains ./collections/ansible_collections/cd60/nce
ansible-galaxy collection build collections/ansible_collections/cd60/nce -f
# Produces cd60-nce-<version>.tar.gz
ansible-galaxy collection install cd60-nce-*.tar.gz --force
```

---

## üöÄ Quick start playbooks

### 1) Obtain a token (module: `nce_auth`)
```yaml
---
- name: Get NCE token
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Obtain a token
      cd60.nce.nce_auth:
        base_uri: https://weu.naas.huawei.com:18002
        username: "{{ lookup('env', 'NCE_USERNAME') }}"
        password: "{{ lookup('env', 'NCE_PASSWORD') }}"
        validate_certs: false
      register: nce_auth

    - debug:
        var: nce_auth.token
```

### 2) Ensure a **Site** is present (module: `nce_site`)
```yaml
---
- name: Ensure site present
  hosts: localhost
  gather_facts: false
  vars:
    nce_token: "{{ lookup('env', 'NCE_TOKEN') | default(none) }}"
  tasks:
    - name: Create or update site
      cd60.nce.nce_site:
        token: "{{ nce_token }}"
        base_uri: https://weu.naas.huawei.com:18002
        validate_certs: false
        selector:
          organizationName: "Nanjing Research Center"
          address: "66 JiangYun Road"
        object:
          name: "site1"
          type: ["AP"]
          description: "site1"
          latitude: "50"
          longitude: "111"
        state: present
```

### 3) Ensure a **Device** is present (module: `nce_device`)
```yaml
---
- name: Ensure device present
  hosts: localhost
  gather_facts: false
  vars:
    nce_token: "{{ lookup('env', 'NCE_TOKEN') }}"
  tasks:
    - name: Create or update device
      cd60.nce.nce_device:
        token: "{{ nce_token }}"
        base_uri: https://weu.naas.huawei.com:18002
        validate_certs: false
        selector:
          esn: "210235AABBCC"
        object:
          name: "SW-Edge-01"
          esn: "210235AABBCC"
          ip: "10.10.10.10"
          siteId: "ea25fdbf-8dee-4823-bac2-5bfe8e3359ca"
        state: present
```

---

## üîé Lookup plugin examples (`nce_lookup`)

**R√©cup√©rer un site par nom**
```yaml
- name: Lookup a site by name
  hosts: localhost
  gather_facts: false
  vars:
    nce_token: "{{ lookup('env', 'NCE_TOKEN') }}"
  tasks:
    - name: Fetch site object
      set_fact:
        site_obj: "{{ lookup('cd60.nce.nce_lookup', 'sites', 'site1', base_uri='https://weu.naas.huawei.com:18002', token=nce_token, validate_certs=False) | first }}"

    - debug:
        var: site_obj
```

**R√©cup√©rer un device par id**
```yaml
- name: Lookup a device by UUID
  hosts: localhost
  gather_facts: false
  vars:
    nce_token: "{{ lookup('env', 'NCE_TOKEN') }}"
  tasks:
    - set_fact:
        dev_obj: "{{ lookup('cd60.nce.nce_lookup', 'devices', 'd3f9b5c2-xxxx-xxxx-xxxx-aaaaaaaaaaaa', base_uri='https://weu.naas.huawei.com:18002', token=nce_token, validate_certs=False) | first }}"

    - debug:
        var: dev_obj
```

---

## üìá Inventory plugin examples (`nce_inventory`)

### Fichier `nce.yml`
```yaml
plugin: cd60.nce.nce_inventory
base_uri: https://weu.naas.huawei.com:18002
token: "{{ nce_token }}"
validate_certs: false
# Optional: filter on sites
# site_ids:
#   - "ea25fdbf-8dee-4823-bac2-5bfe8e3359ca"
```

### Utilisation
```bash
# Lister l‚Äôinventaire
ansible-inventory -i nce.yml --list

# Ex√©cuter un module (ex: debug) sur tous les h√¥tes d√©couverts
ANSIBLE_HOST_KEY_CHECKING=False ansible -i nce.yml all -m debug -a 'var=nce_device.name'
```

> Le plugin ajoute chaque **device** comme h√¥te avec `ansible_host` = **nom du device** et publie l‚Äôobjet brut complet sous `nce_device`.

---

## üß™ Lancer les tests d‚Äôint√©gration

Les tests sont fournis dans `tests/integration/`. Ils couvrent **auth**, **sites**, et **devices** (create / no-op update / delete).

### Pr√©‚Äërequis
- Variables d‚Äôenvironnement :
  ```bash
  export NCE_USERNAME="<tenant-username>"
  export NCE_PASSWORD="<tenant-password>"
  ```
- Acc√®s r√©seau au `base_uri` et √©ventuels proxys configur√©s.

### M√©thode 1 ‚Äî via `Makefile`
```bash
make integration
```
> Astuce : le make cible d√©finit `ANSIBLE_COLLECTIONS_PATHS=./collections`.

### M√©thode 2 ‚Äî en direct
```bash
ANSIBLE_COLLECTIONS_PATHS=./collections ansible-playbook -i tests/integration/inventory tests/integration/site.yml
```

### Lint et build
```bash
make lint   # ansible-lint (tol√©rant sur quelques r√®gles)
make build  # construit l‚Äôartifact Galaxy .tar.gz
```

---

## üß≠ Conventions (rappel)

- **`object`**: toutes les propri√©t√©s configurables d‚Äôun objet (MUST include `name`).
- **`selector`**: mapping cl√©‚Üívaleur pour l‚Äôunicit√© (ne **pas** inclure `name`).
- **Idempotence**: pas de param√®tre d‚Äôop√©ration (cr√©ation vs mise √† jour **auto‚Äëd√©tect√©es**).

---

## ‚ùì Support
Propose des issues/feedbacks dans votre d√©p√¥t GitOps interne, ou ouvrez un ticket au p√¥le R√©seau & Automatisation.


### Developer tools

To create a single-file text bundle (with the extractor script embedded):

```bash
make bundle
